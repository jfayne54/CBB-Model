name: Torvik Proxy Fetch

on:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install tools
        run: sudo apt-get install -y jq curl

      - name: Try fetching Torvik (with retries and browser headers)
        id: torvik
        run: |
          echo "Attempting Torvik fetch..."
          SUCCESS=0

          for i in {1..3}; do
            echo "Attempt $i..."

            curl \
              -A "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
              -H "Accept: application/json, text/plain, */*" \
              -H "Referer: https://barttorvik.com/" \
              -H "Origin: https://barttorvik.com" \
              -H "Sec-Fetch-Site: same-origin" \
              -H "Sec-Fetch-Mode: cors" \
              -H "Sec-Fetch-Dest: empty" \
              -L "https://barttorvik.com/trank.php?year=2026&json=1" \
              -o torvik_raw.json

            echo "Response Preview:"
            head torvik_raw.json || true

            # Validate JSON
            if jq empty torvik_raw.json 2>/dev/null; then
              echo "JSON is valid!"
              SUCCESS=1
              break
            else
              echo "Invalid JSON — likely stalling page. Retrying..."
              sleep 3
            fi
          done

          if [ $SUCCESS -eq 0 ]; then
            echo "❌ FAILED: Could not fetch valid Torvik JSON after 3 attempts."
            exit 1
          fi

      - name: Save Torvik data
        run: |
          mv torvik_raw.json data_torvik.json
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data_torvik.json
          git commit -m "Updated Torvik data" || echo "No changes to commit."
          git push
