name: Torvik Proxy Fetch

on:
  schedule:
    - cron: "0 */6 * * *"   # Runs every 6 hours
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get install -y jq curl

      - name: Fetch Torvik team stats through proxy headers
        run: |
          echo "Fetching Torvik..."
          curl -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36" \
               -H "Accept: application/json" \
               -H "Referer: https://barttorvik.com/" \
               -L "https://barttorvik.com/trank.php?year=2026&json=1" \
               -o torvik_raw.json || exit 1

          echo "Validating JSON..."
          if ! jq empty torvik_raw.json; then
            echo "JSON invalid â€” Torvik likely blocked us."
            exit 1
          fi

      - name: Commit Torvik data
        run: |
          mv torvik_raw.json data_torvik.json
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data_torvik.json
          git commit -m "Updated Torvik data" || echo "No changes"
          git push
